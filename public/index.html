<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Link Space Chat</title>
  <link rel="stylesheet" href="/styles.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>
  <div class="page">
    <header class="topbar">
      <div class="topbar-left">
        <button id="sidebarToggleBtn" class="sidebar-toggle-btn">&#9776;</button>
        <div class="brand" id="brandRoomInfoBtn" title="房间信息">Link Space Chat</div>
      </div>
      <div class="room-id" id="roomIdLabel"></div>
    </header>
    <main class="container">
      <aside class="sidebar">
        <div class="sidebar-content">
          <button id="sidebarCloseBtn" class="sidebar-close-btn">&times;</button>
          <div class="section">
            <div class="section-title">房间信息</div>
            <div id="roomInfo" class="room-info">
              <div id="roomName" class="room-name"></div>
              <div id="roomDescription" class="room-description"></div>
              <div id="roomPasswordStatus" class="room-password-status"></div>
              <button id="editRoomBtn" class="edit-room-btn" style="display: none;">编辑房间</button>
            </div>
          </div>
          <div class="section">
            <div class="section-title">在线用户</div>
            <div class="section-card">
              <ul id="userList" class="user-list"></ul>
            </div>
          </div>
          <div class="section">
            <div class="section-title">加入房间</div>
            <form id="joinForm" class="join-form">
              <input id="nickname" placeholder="昵称" maxlength="24" />
              <input id="roomIdInput" placeholder="房间ID（留空使用URL）" maxlength="40" />
              <input id="roomPasswordInput" type="password" placeholder="房间密码（如有）" maxlength="20" style="display: none;" />
              <button type="submit">进入</button>
            </form>
          </div>
          <div class="section">
              <button id="shareBtn" class="share-btn">分享房间</button>
              <button id="leaveBtn" class="leave-btn">退出房间</button>
          </div>
          <div class="section more-section">
            <button id="moreToggleBtn" class="more-toggle-btn">
              <span>更多工具</span>
              <span id="moreToggleIcon" class="more-toggle-icon">▾</span>
            </button>
            <div id="morePanel" class="more-panel" style="display: none;">
              <div class="more-panel-section">
                <div class="more-panel-title">消息工具</div>
                <div class="search-container">
                  <input type="text" id="searchInput" placeholder="🔍 搜索当前消息..." maxlength="100" />
                  <button id="searchBtn" class="search-btn" title="搜索">🔍</button>
                </div>
                <div id="searchResults" class="search-results" style="display: none;"></div>
              </div>
            </div>
          </div>
        </div>
        <div class="sidebar-footer">
          由 Do It Dui Team 开发
        </div>
      </aside>
      <section class="chat">
        <ul id="messages" class="messages"></ul>
        <div id="rateLimitToast" class="rate-limit-toast">消息发送过于频繁，请稍后再试</div>
        <!-- Phase 3: 回复框 -->
        <div id="replyBox" class="reply-box" style="display: none;">
          <div class="reply-preview">
            <span class="reply-label">回复:</span>
            <span id="replyPreviewText" class="reply-text"></span>
            <button id="cancelReplyBtn" class="cancel-reply-btn" title="取消回复">×</button>
          </div>
        </div>
        <form id="messageForm" class="message-form">
          <input id="messageInput" autocomplete="off" placeholder="输入消息，回车发送" />
          <button type="submit">发送</button>
        </form>
      </section>
    </main>
  </div>

  <!-- Share Modal -->
  <div id="shareModal" class="modal-overlay">
    <div class="modal-content">
      <button id="closeModalBtn" class="modal-close-btn">&times;</button>
      <h3>分享房间</h3>
      <div id="qrCode" class="qr-code"></div>
      <div class="share-link-container">
        <input type="text" id="shareLinkInput" readonly />
        <button id="copyLinkBtn">复制</button>
      </div>
    </div>
  </div>

  <!-- Edit Room Modal -->
  <div id="editRoomModal" class="modal-overlay">
    <div class="modal-content">
      <button id="closeEditModalBtn" class="modal-close-btn">&times;</button>
      <h3>编辑房间</h3>
      <form id="editRoomForm" class="edit-room-form">
        <div class="form-warning">确认保存后，房间名称、描述与密码将不可改动。</div>
        <div class="form-group">
          <label>房间名称</label>
          <input type="text" id="editRoomName" placeholder="房间名称（可选）" maxlength="50" />
        </div>
        <div class="form-group">
          <label>房间描述</label>
          <textarea id="editRoomDescription" placeholder="房间描述（可选）" maxlength="200" rows="3"></textarea>
        </div>
        <div class="form-group">
          <label>房间密码</label>
          <input type="password" id="editRoomPassword" placeholder="留空表示开放房间" maxlength="20" />
          <small>设置密码后，只有知道密码的用户才能加入。默认房间（ID为"1"）不能设置密码。</small>
        </div>
        <div class="form-group" id="editPasswordConfirmGroup" style="display: none;">
          <label>
            <input type="checkbox" id="editPasswordConfirm" />
            修改密码并清空聊天记录
          </label>
          <small>为保护隐私，修改密码会立即清空本房间全部聊天记录。</small>
        </div>
        <div class="form-actions">
          <button type="submit">保存</button>
          <button type="button" id="cancelEditBtn">取消</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Room Info Modal (所有已加入用户可见) -->
  <div id="roomInfoModal" class="modal-overlay">
    <div class="modal-content">
      <button id="closeRoomInfoModalBtn" class="modal-close-btn">&times;</button>
      <h3>房间信息</h3>
      <div class="form-group">
        <label>名称</label>
        <div id="infoRoomName" class="readonly-field"></div>
      </div>
      <div class="form-group">
        <label>描述</label>
        <div id="infoRoomDescription" class="readonly-field"></div>
      </div>
      <div class="form-group">
        <label>密码</label>
        <div class="password-visibility">
          <input type="password" id="infoRoomPassword" class="readonly-input" readonly value="" />
          <button id="togglePasswordVisibleBtn" type="button" class="icon-btn" aria-label="toggle password">👁</button>
        </div>
        <small>仅已加入本房间的用户可见。默认隐藏，点击小眼睛切换显隐。</small>
      </div>
    </div>
  </div>

  <!-- Password Modal -->
  <div id="passwordModal" class="modal-overlay">
    <div class="modal-content">
      <h3>需要密码</h3>
      <p>该房间需要密码才能加入</p>
      <form id="passwordForm" class="password-form">
        <input type="password" id="passwordInput" placeholder="请输入房间密码" maxlength="20" autofocus />
        <div class="form-actions">
          <button type="submit">确认</button>
          <button type="button" id="cancelPasswordBtn">取消</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Prefill Join Modal (从链接预填信息进入) -->
  <div id="prefillJoinModal" class="modal-overlay">
    <div class="modal-content">
      <button type="button" class="modal-close-btn" id="prefillCancelBtn">&times;</button>
      <h3>加入房间</h3>
      <div class="form-group">
        <label>昵称</label>
        <input type="text" id="prefillNickname" placeholder="请输入昵称" maxlength="24" />
      </div>
      <div class="form-group">
        <label>房间ID</label>
        <input type="text" id="prefillRoomId" placeholder="房间ID" maxlength="40" />
      </div>
      <div class="form-group">
        <label>房间密码</label>
        <input type="password" id="prefillPassword" placeholder="如有密码请填写" maxlength="20" />
      </div>
      <div class="form-group">
        <label>房间介绍</label>
        <textarea id="prefillDescription" class="readonly-field" placeholder="（仅展示）" rows="2" readonly></textarea>
      </div>
      <div class="form-actions">
        <button type="button" id="prefillConfirmBtn">确认进入</button>
      </div>
    </div>
  </div>

  <!-- 引入 socket.io 和 qrcode 客户端脚本 -->
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script src="/app.js"></script>
</body>
</html>
